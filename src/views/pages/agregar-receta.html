<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Comparte tus mejores recetas con la comunidad de Cocina Comunitaria" />
    <meta name="theme-color" content="#4CAF50" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Recetas Gourmet" />
    
    <title>Agregar Receta | Cocina Comunitaria</title>
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32x32.png" />
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png" />
    <link rel="manifest" href="manifest.json" />
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/styles.css" />
    
    <!-- PWA Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('ServiceWorker registration successful');
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
  </head>
  <body>
    <header class="header">
      <div class="container">
        <h1 class="logo">Recetas <span class="highlight">Gourmet</span></h1>
        <nav class="nav">
          <a href="index.html" class="nav-link">Inicio</a>
          <a href="agregar.html" class="nav-link active" data-protegido>Agregar Receta</a>
          <a href="categorias.html" class="nav-link" data-protegido>Categorías</a>
        </nav>
        <div class="auth-buttons">
          <span class="usuario" data-usuario></span>
          <button id="btn-logout" class="btn btn-outline" data-auth="logout">Cerrar Sesión</button>
          <button id="btn-login" class="btn" data-auth="login">Iniciar Sesión</button>
        </div>
        <button id="toggle-tema" class="boton-tema">🌓 Cambiar tema</button>
      </div>
    </header>

    <main class="main container">
      <!-- Contenido protegido -->
      <section class="formulario-receta" data-protegido>
        <h2>Comparte tu receta</h2>
        <form id="form-receta">
          <div class="form-group">
            <label for="titulo">Título de la receta</label>
            <input type="text" id="titulo" name="titulo" required />
          </div>

          <div class="form-group">
            <label for="autor">Autor</label>
            <input type="text" id="autor" name="autor" readonly />
          </div>

          <div class="form-group">
            <label for="imagen">URL de imagen</label>
            <input type="url" id="imagen" name="imagen" placeholder="https://..." />
          </div>

          <div class="form-group">
            <label for="categoria">Categoría</label>
            <select id="categoria" name="categoria" required>
              <option value="">Selecciona una categoría</option>
              <option value="Desayuno">Desayuno</option>
              <option value="Almuerzo">Almuerzo</option>
              <option value="Cena">Cena</option>
              <option value="Postre">Postre</option>
              <option value="Bebida">Bebida</option>
            </select>
          </div>

          <div class="form-group">
            <label for="ingredientes">Ingredientes (uno por línea)</label>
            <textarea id="ingredientes" name="ingredientes" rows="5" required></textarea>
          </div>

          <div class="form-group">
            <label for="preparacion">Pasos de preparación (uno por línea)</label>
            <textarea id="preparacion" name="preparacion" rows="6" required></textarea>
          </div>

          <button type="submit" class="btn">Agregar Receta</button>
        </form>

        <div id="mensaje-exito" class="mensaje-exito" style="display: none;">
          ¡Tu receta ha sido guardada! 🎉
        </div>
      </section>

      <!-- Mensaje para usuarios no autenticados -->
      <div class="auth-message" data-auth="login">
        <h2>Acceso Requerido</h2>
        <p>Para agregar recetas, por favor inicia sesión.</p>
        <a href="login.html" class="btn">Iniciar Sesión</a>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <p>&copy; 2025 Cocina Comunitaria. Todos los derechos reservados.</p>
      </div>
    </footer>

    <script type="module">
      import { inicializarAuthMiddleware } from './js/auth-middleware.js';
      import { inicializarAuth, obtenerUsuarioActual } from './js/auth.js';
      import { inicializarTema } from './js/tema.js';
      import { inicializarFormularioReceta } from './js/recetas.js';

      // Inicializar autenticación y middleware
      inicializarAuth();
      inicializarAuthMiddleware();

      // Inicializar formulario solo si el usuario está autenticado
      if (document.querySelector('[data-protegido]').style.display !== 'none') {
        // Establecer el autor automáticamente
        const usuario = obtenerUsuarioActual();
        if (usuario) {
          document.getElementById('autor').value = usuario.email;
        }
        
        inicializarFormularioReceta();
      }

      // Inicializar tema (siempre disponible)
      inicializarTema();
    </script>
  </body>
</html>
